<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Identificación</title>
  <link rel="stylesheet" href="identificacion.css" />
  <link href="https://fonts.googleapis.com/css2?family=Dongle:wght@700&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <!-- Fondo animado -->
  <canvas class="background-binary"></canvas>

  <!-- Login principal -->
  <div class="login-wrapper">
    <h1 class="login-title">Refinador</h1>

    <div class="login-container">
      <label for="username-input" class="sr-only">Nombre</label>
      <input type="text" id="username-input" placeholder="Tu nombre (opcional)" />

      <label for="email-input" class="sr-only">Correo electrónico</label>
      <input type="email" id="email-input" placeholder="Correo electrónico" />
      <span class="error-message" id="email-error"></span>

      <button id="login-button">Entrar</button>

      <div class="divider">o</div>

      <button id="guest-button" class="guest">Entrar como invitado</button>
    </div>
  </div>

  <!-- Modal de selección de avatar -->
  <div class="avatar-modal hidden" id="avatarModal">
    <div class="avatar-modal-content">
      <button class="avatar-close" id="avatarCloseBtn" aria-label="Cerrar">
        <i data-lucide="x"></i>
      </button>
      <h2>Elige un avatar</h2>
      <div class="avatar-grid">
        <i data-lucide="cookie" class="avatar" data-avatar="cookie"></i>
        <i data-lucide="handshake" class="avatar" data-avatar="handshake"></i>
        <i data-lucide="chef-hat" class="avatar" data-avatar="chef-hat"></i>
        <i data-lucide="club" class="avatar" data-avatar="club"></i>
        <i data-lucide="diamond" class="avatar" data-avatar="diamond"></i>
        <i data-lucide="heart" class="avatar" data-avatar="heart"></i>
        <i data-lucide="spade" class="avatar" data-avatar="spade"></i>
        <i data-lucide="bird" class="avatar" data-avatar="bird"></i>
        <i data-lucide="rabbit" class="avatar" data-avatar="rabbit"></i>
        <i data-lucide="turtle" class="avatar" data-avatar="turtle"></i>
      </div>
      <span class="error-message" id="avatar-error"></span>
      <div class="avatar-footer">
        <button id="confirmAvatarBtn" class="confirm-button">
          <i data-lucide="arrow-right"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      lucide.createIcons();

      // Si ya hay sesión activa, redirige
      const session = JSON.parse(localStorage.getItem("session") || "{}");
      if (session?.name && session?.avatar) {
        window.location.replace("index.html");
        return;
      }

      const inputName = document.getElementById("username-input");
      const inputEmail = document.getElementById("email-input");
      const loginButton = document.getElementById("login-button");
      const guestButton = document.getElementById("guest-button");
      const emailError = document.getElementById("email-error");
      const avatarModal = document.getElementById("avatarModal");
      const avatarCloseBtn = document.getElementById("avatarCloseBtn");
      const avatarIcons = document.querySelectorAll(".avatar");
      const confirmButton = document.getElementById("confirmAvatarBtn");
      const avatarError = document.getElementById("avatar-error");

      let selectedAvatar = null;
      let tempSession = null;

      // --- Invitado ---
      guestButton.addEventListener("click", () => {
        tempSession = {
          name: `Invitado_${Math.floor(Math.random() * 1000)}`,
          email: null,
          isGuest: true
        };
        openAvatarModal();
      });

      // --- Login con email ---
      loginButton.addEventListener("click", () => {
        const email = inputEmail.value.trim();
        const name = inputName.value.trim() || email.split("@")[0];

        emailError.textContent = "";

        if (!email || !email.includes("@")) {
          emailError.textContent = "Introduce un correo válido";
          return;
        }

        tempSession = {
          name,
          email,
          isGuest: false
        };

        openAvatarModal();
      });

      // --- Mostrar modal ---
      function openAvatarModal() {
        avatarModal.classList.remove("hidden");
        selectedAvatar = null;
        avatarError.textContent = "";

        avatarIcons.forEach(icon => {
          icon.classList.remove("selected");
          icon.style.backgroundColor = "#f9fafb";
        });
      }

      // --- Cerrar modal ---
      avatarCloseBtn.addEventListener("click", () => {
        avatarModal.classList.add("hidden");
        avatarError.textContent = "";
      });

      // --- Selección visual de avatar ---
      avatarIcons.forEach(icon => {
        icon.addEventListener("click", () => {
          avatarIcons.forEach(a => a.classList.remove("selected"));
          icon.classList.add("selected");
          selectedAvatar = icon;
          avatarError.textContent = "";
        });
      });

      // --- Confirmar avatar ---
      confirmButton.addEventListener("click", () => {
        if (!selectedAvatar || !tempSession) {
          avatarError.textContent = "Selecciona un avatar para continuar";
          return;
        }

        const session = {
          ...tempSession,
          avatar: selectedAvatar.dataset.avatar
        };

        localStorage.setItem("session", JSON.stringify(session));
        window.location.replace("index.html");
      });
    });
  </script>
</body>
</html>
